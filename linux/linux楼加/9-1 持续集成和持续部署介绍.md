# 持续集成和持续部署介绍

## 实验介绍

随着敏捷开发的流行，随之对软件的构建和部署也提出了更高要求。依据团队规模大小，可能每天要进行几次、几十次，甚至上百次的项目构建和部署。传统的手动运维的方式无法再应对这种情况，因此出现了持续集成（Continuous Integration，简称 CI）和持续部署（Continuous Deployment，简称 CD）。持续集成是持续部署的前提，持续部署包含了持续集成，它们中间如果要再细分的话还有一个持续交付（Continuous Delivery）。有时我们会简单的以持续集成来代指三者。

## 实验知识点

- 概念
- 三者关系
- 持续集成价值

## 概念

完整的软件开发流程包括以下阶段：

编码 -> 构建 -> 集成 -> 测试 -> 交付 -> 部署

![](./images/dev_flow.png)

如上图所示，持续集成、持续交付和持续部署的区别在于囊括的阶段不一样，由部分到完整。

“持续集成”一词来源与极限编程（Extreme Programming），是极限编程的 12 个实践原则之一。ThoughtWorks 首席科学家、软件开发领域大师 Martin Fowler 对持续集成是这样定义的：

> 持续集成是一种软件开发实践，即团队开发成员经常集成他们的工作，通常每个成员每天至少集成一次，也就意味着团队每天可能发生多次集成。每次集成都是通过自动化的构建（包括编译、发布、自动化测试）来验证，从而尽快地发现集成错误。许多团队发现这个过程可以大大的减少集成的问题，让团队能够更快的开发高内聚的软件。

从上面的定义可以看出，一个典型的持续集成周期包括以下几个步骤：

1. 版本控制服务器上有最新的代码
1. 持续集成服务器从版本控制服务器下载最新的代码
1. 等代码完全更新以后，调用自动化编译脚本，进行代码编译
1. 运行所有的自动化测试（单元测试、接口测试、系统级别的UI自动化测试等）
1. 将结果写入报告文件中，反馈给团队成员
1. 如果构建失败，必须尽快修改确保下次构建成功
1. 产生可执行的软件版本，提供给测试人员进行测试

持续集成是由代码提交或定时来触发（项目级别的持续集成可以由开发人员每次提交代码时触发，而产品级别的持续集成可以定时触发），每次提交到版本控制服务器上的代码都要经过自动化构建，确保每次的代码变更都不会导致持续集成失败。

![](./images/ci_flow.jpg)

### 持续集成

持续集成强调开发人员提交了新代码之后，立刻进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。

![](./images/continuous_integration.png)

### 持续交付

持续交付在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的类生产环境（production-like environments）中。比如，我们完成单元测试后，可以把代码部署到连接生产环境数据库的 Staging 环境中做更多的测试。如果代码没有问题，再手动部署到生产环境中。

![](./images/continuous_delivery.png)

### 持续部署

持续部署则是在持续交付的基础上，把部署到生产环境的过程自动化。

![](./images/continuous_deployment.png)

## 三者关系

### 持续交付与持续部署

将持续集成扩展到交付和部署就是持续交付和持续部署，二者的区别在于手动还是自动部署到生产环境。

![](./images/delivery_vs_deployment.jpg)

### 持续集成步骤

完整的持续集成步骤如下（假设使用 Docker 容器来部署）：

![](./images/ci_steps.png)

## 持续集成的价值

开发人员对下面这些软件开发场景很熟悉，比如：

场景一：开发了新功能，老功能产生新的 bug；

场景二：修好一个 bug，又产生其它 bug，甚至出现连环 bug；

场景三：出现的 bug 比较多，修改代码要很谨慎，不熟悉的模块一般不敢动，怕引起问题；

使用持续集成可以缓解这个问题，Martin Fowler 大师曾经说过：

> “Continuous Integration doesn’t get rid of bugs, but it does make them dramatically easier to find and remove.” — Martin Fowler

也就是，持续集成不能消除 bug ，但能更容易地发现 bug，更快速地修复，提升产品质量。

那么，持续集成具体能给我们带来哪些价值？

![](./images/ci_values.jpg)

引入了持续集成以后，每个开发人员在提交代码的时候都会自动进行构建，包括代码审查、编译、单元测试、打包、功能测试等。这样保证了开发人员的每次提交都是安全的。打包生成的文件随时可以被测试人员拿去测试。如果需要给客户演示功能，也只需从持续集成服务器上直接获取指定的打包文件即可。

### 减少风险

缺陷的检测和修复变得更快，让寻找和修改 bug 的工作变简单（只修改系统一小部分，无需看太多代码。由于提交后就可以得到反馈，记忆很新鲜，可以进行差异调试）。同时过早的引入集成，使我们能更好的审视各个模块的接口是否满足要求，减少项目中的假定。

### 减少重复过程

由于持续集成将大量的工作给自动化了，那么可以让人们有时间做更多的需要动脑筋的、更高价值的工作。而且通过对重要过程自动化，克服了项目中某些成员对实现改进的抵制，有利于持续集成的推进。这样就形成了一个良性循环。

### 在任何时间、任何地点生成可部署的软件

对于客户来说，可以部署的软件是最实际的资产。而持续集成则可以轻松做到这一点。

### 增强项目的可见性

通过对持续集成服务器的监控，可以随时了解项目的趋势。持续集成上的红色或绿色表示了当前项目的健康程度。每一个功能的交付都经历了单元测试或集成测试的考验。

### 对开发团队的软件产品建立起更强大的产品信心

持续集成可以防止破窗综合症，让开发团队一点点积累起对产品的信息。

## 实验总结

本次实验我们学习了持续集成的概念和价值，认识到了持续集成的重要性，那么接下来我们将学习如何使用 Jenkins 来实现持续集成。